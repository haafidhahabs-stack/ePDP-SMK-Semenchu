<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>e-PDP SMK Semenchu</title>
<meta name="theme-color" content="#a8e6cf">
<link rel="manifest" href="manifest.json">

<style>
  :root{
    --bg:#d9f4e0;
    --green:#1b5e20;
    --accent:#6a1b9a;
    --card:#ffffff;
  }
  html,body{height:100%;margin:0;font-family:Inter, "Poppins", system-ui, sans-serif;background:linear-gradient(135deg,var(--bg),#eaf8ef);}
  header{height:64px;display:flex;align-items:center;justify-content:center;background:var(--green);color:white;font-weight:700;font-size:18px}
  .app {position:relative;height:calc(100vh - 64px);overflow:hidden}
  .controls {
    position:absolute;left:50%;transform:translateX(-50%);top:10px;
    z-index:60;width:calc(100% - 24px);max-width:900px;
    background:rgba(255,255,255,0.98);border-radius:12px;padding:10px;
    display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    box-shadow:0 8px 20px rgba(0,0,0,0.08);
  }
  select{flex:1;min-width:160px;padding:10px;border-radius:8px;border:1px solid #d0d0d0;background:#fff}
  .btn {padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
  .btn-primary{background:var(--green);color:#fff}
  .btn-accent{background:var(--accent);color:#fff}
  .slot {display:flex;gap:8px;align-items:center}
  .slot input{display:none}
  .slot label{background:#e6f2ea;padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--green);font-weight:600}
  .slot input:checked + label{background:var(--green);color:#fff}
  .camera-wrap {position:absolute;left:0;top:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center}
  #reader {width:100%;height:100%;object-fit:cover;background:#000}
  .cam-controls-bottom {position:absolute;left:12px;bottom:14px;z-index:55;display:flex;flex-direction:column;gap:8px}
  .icon-btn {background:rgba(255,255,255,0.95);border-radius:12px;padding:8px;border:0;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
  .status {position:absolute;left:50%;transform:translateX(-50%);top:calc(50% - 14px);z-index:45;background:rgba(0,0,0,0.5);color:#fff;padding:6px 12px;border-radius:20px;font-weight:600}
  .hidden {display:none!important}
  @media(max-width:520px){
    .controls{padding:8px;gap:6px}
    select{min-width:120px}
    header{font-size:16px}
  }
</style>
</head>
<body>
<header>e-PDP SMK Semenchu</header>

<div class="app" role="application">
  <div class="controls" role="region" aria-label="Kawalan">
    <select id="namaGuru" aria-label="Pilih Nama Guru"><option value="">-- Pilih Nama Guru --</option></select>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="modBtn" class="btn btn-primary" title="Mod Gantian">Mod Gantian: ‚ùå</button>
    </div>

    <div class="slot" role="radiogroup" aria-label="Tempoh Masa">
      <input type="radio" id="s30" name="slot" value="30 minit" checked><label for="s30">30</label>
      <input type="radio" id="s60" name="slot" value="60 minit"><label for="s60">60</label>
      <input type="radio" id="s90" name="slot" value="90 minit"><label for="s90">90</label>
    </div>
  </div>

  <div class="camera-wrap" aria-live="polite">
    <div id="reader" aria-label="Kamera Imbas"></div>

    <!-- cam controls moved to bottom-left to avoid overlapping top controls -->
    <div class="cam-controls-bottom" id="camControls">
      <button id="toggleCam" class="icon-btn" title="Tukar Kamera">üì∑</button>
      <!-- torch button kept but hidden; auto torch handled by brightness check -->
      <button id="toggleTorch" class="icon-btn hidden" title="Torch">üí°</button>
    </div>

    <div class="status" id="status">üì∑ Sila pilih nama guru untuk mulakan</div>
  </div>
</div>

<!-- library -->
<script src="<script src="html5-qrcode.min.js"></script>
"></script>

<script>
/* ============ CONFIG ============ */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzorm9vEvPqLgUtYnxFQ6eElcH2AMwodPwZCzdj4XZdfsrP-oilXV_PnVsAtChPtAOF/exec";
/* ================================= */

const namaGuruEl = document.getElementById('namaGuru');
const modBtn = document.getElementById('modBtn');
const statusEl = document.getElementById('status');
const toggleCamBtn = document.getElementById('toggleCam');
const toggleTorchBtn = document.getElementById('toggleTorch');
const camControls = document.getElementById('camControls');

let modGantian = false;
let html5QrCode = null;
let cameras = [];
let currentCameraIndex = 0;
let torchTrack = null;
let torchOn = false;
let lastScanTime = 0;
let brightnessMonitor = null;
let brightnessVideo = null;
let brightnessCanvas = null;
let brightnessCtx = null;

// load teacher list from Apps Script (GET)
async function loadTeachers(){
  try{
    const res = await fetch(WEBAPP_URL);
    const names = await res.json();
    names.forEach(n => {
      const opt = document.createElement('option'); opt.value = n; opt.textContent = n;
      namaGuruEl.appendChild(opt);
    });
  }catch(e){
    console.error('Load teachers error', e);
    statusEl.textContent = '‚ö†Ô∏è Gagal dapatkan senarai guru';
  }
}

// toggle mod
modBtn.addEventListener('click', ()=>{
  modGantian = !modGantian;
  modBtn.textContent = modGantian ? 'Mod Gantian: ‚úÖ' : 'Mod Gantian: ‚ùå';
  modBtn.classList.toggle('btn-accent', modGantian);
});

// when teacher selected, start
namaGuruEl.addEventListener('change', async ()=>{
  if(!namaGuruEl.value){ await stopScanner(); statusEl.textContent = 'üì∑ Sila pilih nama guru untuk mulakan'; return; }
  statusEl.textContent = '‚è≥ Mengaktifkan kamera...';
  await initCamerasAndStart();
});

// init cameras + start scanner
async function initCamerasAndStart(){
  try{
    if(typeof Html5Qrcode === 'undefined'){ statusEl.textContent = '‚ùå QR library belum dimuat'; return; }
    await stopScanner();
    cameras = await Html5Qrcode.getCameras();
    if(!cameras || cameras.length===0) throw new Error('Tiada kamera ditemui');
    currentCameraIndex = chooseCameraIndex(cameras,'environment');
    await startScannerWithCameraId(cameras[currentCameraIndex].id);
  }catch(err){
    console.error(err);
    statusEl.textContent = '‚ùå Tidak dapat buka kamera: ' + (err.message||err);
  }
}

function chooseCameraIndex(camList, prefer){
  for(let i=0;i<camList.length;i++){
    const lab = (camList[i].label||'').toLowerCase();
    if(prefer==='environment' && (lab.includes('back')||lab.includes('rear')||lab.includes('environment'))) return i;
    if(prefer==='user' && (lab.includes('front')||lab.includes('face')||lab.includes('user'))) return i;
  }
  return 0;
}

async function startScannerWithCameraId(cameraId){
  html5QrCode = new Html5Qrcode("reader", false);
  try{
    await html5QrCode.start(
      cameraId,
      { fps: 10, qrbox: { width: Math.min(window.innerWidth, 360) } },
      qrMsg => onScanSuccess(qrMsg),
      err => {}
    );
    statusEl.textContent = 'üîç Kamera aktif ‚Äî imbas kod QR';
    // start brightness monitor to auto enable torch if dark
    startBrightnessMonitor(cameraId);
  }catch(e){
    console.error('start error', e);
    throw e;
  }
}

// brightness monitor: create small hidden video & canvas to compute avg brightness
async function startBrightnessMonitor(deviceId){
  stopBrightnessMonitor(); // ensure no duplicates
  try{
    brightnessVideo = document.createElement('video');
    brightnessVideo.setAttribute('playsinline','');
    brightnessVideo.style.width = '160px'; brightnessVideo.style.height = '120px';
    brightnessVideo.style.position = 'fixed'; brightnessVideo.style.left = '-9999px';
    document.body.appendChild(brightnessVideo);

    const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } });
    brightnessVideo.srcObject = stream;
    await brightnessVideo.play();

    brightnessCanvas = document.createElement('canvas');
    brightnessCanvas.width = 160; brightnessCanvas.height = 120;
    brightnessCtx = brightnessCanvas.getContext('2d');

    brightnessMonitor = setInterval(async ()=>{
      try{
        brightnessCtx.drawImage(brightnessVideo,0,0,160,120);
        const img = brightnessCtx.getImageData(0,0,160,120);
        let total = 0; for(let i=0;i<img.data.length;i+=4){ total += (img.data[i]+img.data[i+1]+img.data[i+2])/3; }
        const avg = total / (160*120);
        // threshold (0-255), if dark -> try torch
        if(avg < 60) { // very dark
          if(!torchOn) tryEnableTorch(deviceId);
        } else {
          // if it was turned on automatically and environment brightens, turn off for battery
          if(torchOn && torchTrack && torchTrack.applyConstraints) {
            try{ await torchTrack.applyConstraints({ advanced: [{ torch: false }] }); torchOn = false; statusEl.textContent = 'üí§ Flash dimatikan'; }catch(e){}
          }
        }
      }catch(e){ /*ignore frame errors*/ }
    },1000);
  }catch(e){
    // can't create stream for brightness: ignore silently
    stopBrightnessMonitor();
  }
}

function stopBrightnessMonitor(){
  if(brightnessMonitor) { clearInterval(brightnessMonitor); brightnessMonitor = null; }
  if(brightnessVideo && brightnessVideo.srcObject){
    const tracks = brightnessVideo.srcObject.getTracks();
    tracks.forEach(t=>t.stop());
    brightnessVideo.srcObject = null;
  }
  if(brightnessVideo){ try{ brightnessVideo.remove(); }catch(e){} brightnessVideo = null; }
  if(brightnessCanvas){ try{ brightnessCanvas.remove(); }catch(e){} brightnessCanvas = null; brightnessCtx = null; }
}

// try to enable torch via a getUserMedia track (deviceId)
async function tryEnableTorch(deviceId){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } });
    const track = stream.getVideoTracks()[0];
    const caps = track.getCapabilities ? track.getCapabilities() : {};
    if(caps && caps.torch){
      try{
        await track.applyConstraints({ advanced: [{ torch: true }] });
        torchTrack = track; torchOn = true;
        statusEl.textContent = 'üí° Flash diaktifkan';
        // keep track but do not stop stream (torchTrack will keep camera on)
      }catch(e){
        // cannot apply torch
        track.stop();
      }
    } else {
      track.stop();
    }
  }catch(e){
    // ignore
  }
}

// manual toggle camera
toggleCamBtn.addEventListener('click', async ()=>{
  if(cameras.length <= 1) return alert('Hanya satu kamera tersedia');
  currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
  statusEl.textContent = '‚è≥ Menukar kamera...';
  await stopScanner();
  await startScannerWithCameraId(cameras[currentCameraIndex].id);
});

// on scan success
async function onScanSuccess(qrText){
  const now = Date.now();
  if(now - lastScanTime < 800) return; // debounce
  lastScanTime = now;

  if(navigator.vibrate) navigator.vibrate(180);
  statusEl.textContent = '‚úÖ QR dikesan: ' + qrText;

  const slot = document.querySelector('input[name="slot"]:checked').value;
  const payload = {
    namaGuru: namaGuruEl.value,
    kelas: qrText,
    jenis: (/relif/i).test(qrText) ? 'Relif' : 'Kelas',
    modGantian: modGantian ? 'Ya' : 'Tidak',
    tempoh: slot,
    tarikh: new Date().toLocaleDateString('ms-MY'),
    masaImbasan: new Date().toLocaleTimeString('ms-MY')
  };

  try{ await html5QrCode.stop(); }catch(e){}

  try{
    await fetch(WEBAPP_URL, { method:'POST', body: JSON.stringify(payload), headers:{'Content-Type':'application/json'} });
    statusEl.textContent = 'üì§ Rekod berjaya dihantar';
  }catch(e){
    console.error('send fail',e);
    statusEl.textContent = '‚ùå Gagal hantar rekod';
  }

  // restart shortly
  setTimeout(async ()=> {
    try{
      if(html5QrCode) html5QrCode.clear();
      await startScannerWithCameraId(cameras[currentCameraIndex].id);
    }catch(e){
      console.warn('restart fail',e);
    }
  },1200);
}

// stop scanner + torch + monitors
async function stopScanner(){
  try{ if(html5QrCode){ await html5QrCode.stop(); html5QrCode.clear(); html5QrCode = null; } }catch(e){}
  if(torchTrack){ try{ torchTrack.stop(); }catch(e){} torchTrack = null; torchOn = false; }
  stopBrightnessMonitor();
}

// init on load
window.addEventListener('load', async ()=>{
  await loadTeachers();
  // pre-fetch cameras list to speed switching (may fail silently if no permission yet)
  try{ cameras = await Html5Qrcode.getCameras(); }catch(e){ /*ignored*/ }
});

// cleanup
window.addEventListener('beforeunload', async ()=>{ await stopScanner(); });
</script>
</body>
</html>

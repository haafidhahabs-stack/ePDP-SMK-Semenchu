<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>e-PDP SMK Semenchu</title>
<meta name="theme-color" content="#a8e6cf">
<link rel="manifest" href="manifest.json">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:"Poppins",sans-serif;background:#d9f4e0;display:flex;flex-direction:column;}
header{padding:15px;text-align:center;background:#1b5e20;color:#fff;font-size:1.5em;font-weight:bold;}
.controls{padding:10px;background:#fff;display:flex;flex-direction:column;gap:10px;z-index:10;}
select,label{font-size:1em;padding:8px;}
.radio-group{display:flex;gap:10px;}
#modGantianBtn{padding:8px;background:#2e7d32;color:#fff;border:none;border-radius:6px;font-weight:bold;cursor:pointer;width:150px;}
#modGantianBtn.active{background:#6a1b9a;}
#reader{flex:1;background:#000;position:relative;display:flex;justify-content:center;align-items:center;}
.cam-icon{position:absolute;top:10px;right:10px;width:35px;height:35px;background:rgba(255,255,255,0.7);border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;z-index:100;font-size:18px;}
.status{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);color:#fff;background:rgba(0,0,0,0.5);padding:5px 10px;border-radius:6px;font-size:0.9em;}
</style>
</head>
<body>

<header>e-PDP SMK Semenchu</header>

<div class="controls">
  <select id="namaGuru"><option value="">-- Pilih Nama Guru --</option></select>
  <button id="modGantianBtn">Mod Gantian</button>
  <div class="radio-group">
    <label><input type="radio" name="slot" value="30">30 minit</label>
    <label><input type="radio" name="slot" value="60">60 minit</label>
    <label><input type="radio" name="slot" value="90">90 minit</label>
  </div>
</div>

<div id="reader">
  <div id="switchCamera" class="cam-icon">ðŸ“·</div>
  <div class="status" id="status">ðŸ“· Sila pilih nama guru</div>
</div>

<script src="html5-qrcode.min.js"></script>
<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzorm9vEvPqLgUtYnxFQ6eElcH2AMwodPwZCzdj4XZdfsrP-oilXV_PnVsAtChPtAOF/exec";
const namaGuru=document.getElementById('namaGuru');
const status=document.getElementById('status');
const modBtn=document.getElementById('modGantianBtn');
const switchCam=document.getElementById('switchCamera');
let html5QrCode=null;
let cameras=[];
let currentCameraIndex=0;
let modGantian=false;

// toggle Mod Gantian
modBtn.addEventListener('click',()=>{
  modGantian=!modGantian;
  modBtn.classList.toggle('active',modGantian);
});

// fetch teacher list from Google Sheet
fetch(WEBAPP_URL+"?action=getTeachers")
.then(res=>res.json())
.then(data=>{
  data.forEach(n=>{
    const o=document.createElement('option'); o.value=n; o.textContent=n;
    namaGuru.appendChild(o);
  });
});

// start camera
async function startCamera(cameraId){
  if(html5QrCode){ try{ await html5QrCode.stop(); } catch(e){} }
  html5QrCode=new Html5Qrcode("reader");
  html5QrCode.start(
    cameraId,
    { fps:10, qrbox:250, experimentalFeatures:{useBarCodeDetectorIfSupported:true} },
    qr=>{
      status.textContent="QR dikesan: "+qr;
      navigator.vibrate([200,100,200]);
      const slot=document.querySelector('input[name="slot"]:checked')?.value||"30";
      fetch(WEBAPP_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          namaGuru:namaGuru.value,
          kelas:qr,
          modGantian:modGantian?"Ya":"Tidak",
          tempoh:slot,
          tarikh:new Date().toLocaleDateString("ms-MY"),
          masaImbasan:new Date().toLocaleTimeString("ms-MY")
        })
      });
    },
    err=>{}
  );
}

// pilih nama guru â†’ auto kamera
namaGuru.addEventListener('change',async ()=>{
  if(!namaGuru.value){ status.textContent="ðŸ“· Sila pilih nama guru"; return; }
  status.textContent="ðŸ” Mengaktifkan kamera...";
  try{ cameras=await Html5Qrcode.getCameras(); } catch(e){ status.textContent="âŒ Tiada kamera"; return; }
  if(cameras.length===0){ status.textContent="âŒ Tiada kamera"; return; }

  // pilih kamera belakang default
  let rearCamera = cameras.find(cam => cam.label.toLowerCase().includes("back") || cam.label.toLowerCase().includes("rear")) || cameras[0];
  currentCameraIndex=cameras.indexOf(rearCamera);
  startCamera(rearCamera.id);
});

// tukar kamera
switchCam.addEventListener('click',()=>{
  if(cameras.length<2) return;
  currentCameraIndex=(currentCameraIndex+1)%cameras.length;
  startCamera(cameras[currentCameraIndex].id);
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>e-PDP SMK Semenchu</title>
  <meta name="theme-color" content="#a8e6cf">
  <link rel="manifest" href="manifest.json">
  <style>
    body { margin:0; height:100vh; display:flex; flex-direction:column; }
    header { background:#1b5e20; color:#fff; text-align:center; padding:10px; }
    .controls { padding:10px; background:#fff; z-index:10; }
    #reader { flex:1; background:#000; }
    .status { text-align:center; padding:8px; background:rgba(0,0,0,0.5); color:#fff; }
  </style>
</head>
<body>
  <header>e-PDP SMK Semenchu</header>
  <div class="controls">
    <select id="namaGuru"><option value="">-- Pilih Nama Guru --</option></select>
  </div>
  <div id="reader"></div>
  <div class="status" id="status">üì∑ Sila pilih nama guru</div>

  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzorm9vEvPqLgUtYnxFQ6eElcH2AMwodPwZCzdj4XZdfsrP-oilXV_PnVsAtChPtAOF/exec";
    const namaGuru = document.getElementById('namaGuru');
    const status = document.getElementById('status');
    let html5QrCode = null;
    let cameras = [];

    // Load teacher list
    fetch(WEBAPP_URL).then(r=>r.json()).then(list=>{
      list.forEach(n=>{
        const o = document.createElement('option');
        o.value = n; o.textContent = n;
        namaGuru.appendChild(o);
      });
    });

    namaGuru.addEventListener('change', async () => {
      if (!namaGuru.value) { status.textContent = 'üì∑ Sila pilih nama guru'; return; }
      status.textContent = 'üîç Mengaktifkan kamera...';
      if (html5QrCode) {
        try { await html5QrCode.stop(); } catch(e){}
      }
      html5QrCode = new Html5Qrcode("reader");
      try {
        cameras = await Html5Qrcode.getCameras();
        const cameraId = cameras.length > 0 ? cameras[0].id : null;
        if (!cameraId) throw new Error("Tiada kamera");
        await html5QrCode.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          (qr)=> {
            status.textContent = 'QR dikesan: ' + qr;
            // send data
            fetch(WEBAPP_URL, {
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              body: JSON.stringify({
                namaGuru: namaGuru.value,
                kelas: qr,
                modGantian: 'Tidak',
                tempoh: '30 minit',
                tarikh: new Date().toLocaleDateString('ms-MY'),
                masaImbasan: new Date().toLocaleTimeString('ms-MY')
              })
            });
          },
          (err)=> {}
        );
      } catch(e) {
        console.error(e);
        status.textContent = '‚ùå Kamera gagal: ' + (e.message||e);
      }
    });
  </script>
</body>
</html>
